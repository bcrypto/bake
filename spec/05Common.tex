\chapter{Общие положения}\label{COMMON}

\section{Назначение}\label{COMMON.Dest}

Настоящий стандарт определяет криптографические протоколы,
которые позволяют двум сторонам сформировать общий,
только им известный, ключ.                      
%
Ключ формируется так, что ни одна из сторон
не может определить его значение самостоятельно, 
без данных от противоположной стороны.

Общий ключ представляет собой двоичное слово длины~$256$.
%
Этот ключ может использоваться для аутентификации, 
шифрования, имитозащиты, выработки других общих секретных данных.
%
В криптографических алгоритмах, длины ключей которых меньше 256, 
может использоваться только часть общего ключа. При формировании этой 
части в общем ключе следует отбрасывать последние символы и оставлять 
первые.

Протоколы построены по схемам MQV~\cite{MQV}, 
STS~\cite{STS} и PACE~\cite{PACE}.
%
Схема определяет общий вид протокола и не содержит исчерпывающих деталей,
обеспечивающих совместимость различных его реализаций.
%
В настоящем стандарте
зафиксированы все базовые криптографические алгоритмы схем, 
окончательно определены действия сторон,
уточнены форматы передаваемых сообщений.
В схемы~MQV и~STS встроены алгоритмы ЭЦП, 
схожие с алгоритмами СТБ~34.101.45.
%
В схеме~STS выработка одноразовой подписи
совмещена с расчетом одноразовых открытых ключей.
%
Окончательные протоколы названы BMQV~(\ref{MQV}), 
BSTS~(\ref{STS}) и BPACE~(\ref{PACE}).

Протоколы BMQV и BSTS
позволяют сторонам сформировать общий ключ, 
используя долговременные личные ключи и обмениваясь 
соответствующими открытыми ключами.
%
Эффективность BMQV выше, но BSTS дополнительно
обеспечивает анонимность~---
злоумышленник, который не вступает во взаимодействие со сторонами, 
а только перехватывает их сообщения,
не получает информации о том, какие стороны 
участвуют в протоколе.

Протокол BPACE позволяет сторонам сформировать общий ключ, 
используя общий пароль.
%
Злоумышленнику, который перехватывает все сообщения протокола 
(вступая или не вступая во взаимодействие со сторонами),
вычислительно трудно определить пароль, 
даже если он короткий или низкоэнтропийный.
%
Выполняя сеанс протокола с легальной стороной, 
злоумышленник может проверить только один вариант пароля.

Все протоколы настоящего стандарта обеспечивают 
конфиденциальность ключей, сформированных сторонами.
%
Кроме этого, в протоколах предусмотрена проверка того, 
что та или другая сторона сформировала корректный ключ,
совпадающий с ключом противоположной стороны.
%
Такая проверка называется явным подтверждением ключа.
%
Подтверждать ключ может либо одна, 
либо обе стороны.
%
Явное подтверждение ключа является обязательной частью~BSTS
и необязательной частью~BMQV и~BPACE. 

Даже если подтверждение ключа явно не включено в протокол,
оно может быть неявно выполнено после его завершения.
Если, например, стороны используют общий ключ для 
шифрования структурированных данных, 
то нарушение формата данных после расшифрования 
является признаком того, что ключи сторон отличаются.

Успешное подтверждение ключа в протоколе BPACE означает, что 
сторона знает секретный пароль.
%
Поэтому протокол может использоваться для аутентификации
сторон друг перед другом.

Успешное подтверждение ключа в протоколах BMQV и BSTS означает, 
что сторона с определенным идентификатором
владеет долговременным личным ключом, 
который соответствует отосланному ею открытому ключу. 
Данные протоколы также могут использоваться для аутентификации,
если дополнительно проверяется соответствие между 
идентификатором и долговременным открытым ключом стороны. 
Такое соответствие устанавливается 
за рамками протоколов и фиксируется 
в сертификатах (см.~\ref{COMMON.Cert}).

В протоколах используются вычисления в группе 
точек эллиптической кривой над конечным простым полем.
%
Сначала стороны формируют общую секретную точку кривой,
а затем по ней и дополнительным открытым данным
(в том числе сообщениям протокола) 
вырабатывают общий ключ.
%
Для этого используется алгоритм построения ключа, 
определенный в~\ref{KDF}.  
%
С помощью этого алгоритма формируются 
также служебные ключи, 
предназначенные для имитозащиты и шифрования 
служебных данных протоколов.

В~\ref{SWU} определяется вспомогательный алгоритм 
преобразования двоичного слова в точку эллиптической кривой.
Этот алгоритм используется в протоколе~BPACE.
Алгоритм построен в соответствии с~\cite{SWU}.

Все протоколы настоящего стандарта основаны на протоколе
Диффи~--- Хеллмана, который описывается в приложении~\ref{DH}.
В этом приложении обсуждается стойкость протокола,
и определяются условия его безопасного встраивания 
в высокоуровневые протоколы. 

В приложении~\ref{TEST} приводятся примеры выполнения 
протоколов BMQV, BSTS, BPACE.
Примеры можно использовать для проверки корректности реализаций 
протоколов.

В приложении~\ref{ASN} приводится модуль
абстрактно-синтаксической нотации версии~1 (АСН.1),
определенной в~ГОСТ 34.973.
Модуль задает идентификаторы протоколов и других объектов 
стандарта, описывает структуры данных для хранения 
ключей и параметров.
%
Рекомендуется использовать модуль 
при встраивании протоколов в информационные системы, 
в которых также используется АСН.1.

\section{Стойкость}\label{COMMON.Strength}

Протоколы построены так, что злоумышленнику 
вычислительно трудно определить общий ключ или 
выдать себя за другую сторону, не зная долговременный 
личный ключ этой стороны (BMQV, BSTS) или общий пароль (BPACE).

Стойкость протоколов определяется уровнем~$\ell\in\{128,192,256\}$.
%
На уровне~$\ell$ для определения общего ключа по сообщениям
протокола злоумышленнику требуется выполнить 
порядка~$2^\ell$ операций. 
%
Cтойкость основывается на сложности дискретного логарифмирования 
в группе точек эллиптической кривой и на сложности вычислительной задачи 
Диффи~--- Хеллмана в этой группе (см. приложение~\ref{DH}).
%
Оценки стойкости не изменятся, если на уровне~$\ell\in\{128,192\}$ длина общего
ключа уменьшится c~$256$ до~$\ell$.

Протоколы обеспечивают защиту от <<чтения назад>>. 
Это значит, что определение общего ключа остается такой же трудной
задачей, даже если злоумышленнику, дополнительно к сообщениям протокола,
становятся известными долговременные личные ключи сторон или
их общий пароль, но остаются неизвестными одноразовые 
личные или секретные ключи.
%
%%Получив долговременные личные ключи стороны~$A$,
%злоумышленник может выдать себя за~$A$ стороне~$B$,
%но не может выдать себя за~$B$ стороне~$A$.

% todo: раскрытие общего ключа
% todo: раскрытие одноразовых ключей

Уровень~$\ell$ определяет длины параметров, 
ключей, сообщений и, соответственно, быстродействие протоколов. 
%
Следует учитывать, что с ростом~$\ell$, кроме повышения стойкости,
снижается быстродействие.

Явное подтверждение ключа основано на проверке имитовставок,
вычисленных на общем служебном ключе. 
Злоумышленник, который не знает этот ключ, 
может обойти механизм подтверждения только в одном из~$2^{64}$ сеансов
протокола в среднем. 
%
В протоколе BSTS, кроме имитовставок, 
проверяются также зашифрованные одноразовые подписи и сертификаты, 
поэтому надежность подтверждения ключа в BSTS еще выше.

Явное подтверждение ключа выполняется так, что злоумышленник
не может подтвердить ключ, отвечая данными,
которыми подтверждает ключ противоположная сторона.
%
Неявное подтверждение ключа, выполняемое за рамками BMQV и BSTS, 
также должно обладать этим свойством.

Стойкость механизма аутентификации основана на 
стойкости механизма подтверждения ключа и, дополнительно 
для~BMQV и BSTS, на надежности связывания 
идентификаторов сторон с их открытыми ключами в сертификатах 
(см.~\ref{COMMON.Cert}).
%
Если связывание задается с помощью ЭЦП доверенной стороны,
то надежность связывания определяется стойкостью алгоритмов ЭЦП.

%Выводы о стойкости сохраняются и тогда, когда $A=B$.

\section{Параметры эллиптической кривой}\label{COMMON.Params}

{\bf Модуль~$p$.} 
Используется простое число $p$, которое удовлетворяет условиям:
$2^{2\ell-1}<p<2^{2\ell}$, $p\equiv 3\pmod{4}$.
%
Модуль определяет поле~$\FF_p$, 
над которым строится эллиптическая кривая.
%
Можно использовать произвольное допустимое~$p$, 
в том числе простое специального вида.

{\bf Коэффициенты $a$, $b$.} 
Используются числа $a,b\in\FF_p$, которые удовлетворяют условиям:
$a\neq 0$,
$b$ является квадратичным вычетом по модулю~$p$,
$4a^3+27b^2\not\equiv 0\pmod{p}$.
%
Коэффициенты~$a$, $b$ вместе с модулем~$p$ 
определяют группу точек эллиптической кривой~$E_{a,b}(\FF_p)$.

{\bf Порядок~$q$.}
После построения группы~$E_{a,b}(\FF_p)$ рассчитывается 
ее порядок~$q=|E_{a,b}(\FF_p)|$.
%
Выбирается группа, порядок которой удовлетворяет следующим ограничениям:
$q$~--- простое,
$2^{2\ell-1}<q<2^{2\ell}$,
$q\neq p$,
$q$ не делит числа вида $p^m-1$ для~$m=1,2,\ldots,50$.

{\bf Базовая точка $G$.}
Используется базовая
точка $G\in E_{a,b}^*(\FF_p)$ вида $G=(0,y_G)$,
где~$y_G=b^{(p+1)/4}\bmod{p}$.
%
Кратные $G$, $2G$,\ldots, $(q-1)G$ базовой точки
пробегают все элементы~$E_{a,b}^*(\FF_p)$, а $qG=O$.

Параметры должны генерироваться с помощью алгоритма, определенного в
СТБ~34.101.45 (пункт 6.1.3), и, соответственно, должны удовлетворять 
условиям алгоритма проверки параметров, также определенного в СТБ~34.101.45 
(пункт 6.1.4).

В СТБ~34.101.45 (приложение~Б) приводятся стандартные 
наборы параметров эллиптической кривой, которые можно использовать 
напрямую, без повторной генерации или проверки.

\section{Долговременные ключи}\label{COMMON.Static}

В протоколах BMQV и BSTS стороны используют долговременные
личный и открытый ключи.
%
Личным ключом является число~$d\in\{1,2,\ldots,q-1\}$.
По личному ключу определяется открытый ключ~$Q\in E_{a,b}^*(\FF_p)$.
Для генерации пары ключей должен использоваться алгоритм,
определенный в СТБ~34.101.45 (пункт 6.2.2).

При хранении и распространении
должны обеспечиваться конфиденциальность и контроль целостности личного 
ключа, контроль целостности открытого ключа.

Долговременный личный ключ~$d$ должен использоваться только 
в определенном протоколе: BMQV или BSTS. 
Ключ~$d$ может дополнительно использоваться в алгоритмах ЭЦП, 
определенных в СТБ~34.101.45, например,
для проверки владения ключом 
при формировании сертификатов, как это описано в~\ref{COMMON.Cert}. 
Использование личного ключа в других алгоритмах запрещено.

В информационных системах ключи представляются двоичными словами.
Для обеспечения совместимости рекомендуется представлять
личный ключ~$d$ словом~$\langle d\rangle_{2\ell}$,
а открытый ключ~$Q$~--- словом~$\langle Q\rangle_{4\ell}$.

\section{Пароль}\label{COMMON.Pwd}

В протоколе BPACE стороны используют общий секретный пароль.
%
Паролем является двоичное слово, 
длина которого кратна~$8$. Это слово может являться
кодированным представлением обычной текстовой строки. 
Кодировать рекомендуется по правилам UTF-8, 
заданным в~\cite{UTF8}.

\section{Сертификаты}\label{COMMON.Cert}

Стороны протоколов BMQV и BSTS характеризуются отличительными
идентификаторами~$Id$.
%
Долговременный открытый ключ~$Q$ стороны 
связывается с ее идентификатором и распространяется
в виде сертификата~$\Cert(Id,Q)\in\{0,1\}^*$.
%
При выполнении протокола сертификат проверяется,
Проверка сертификата должна включать 
проверку корректности связывания
и проверку того, что~$Q$ действительно является аффинной
точкой эллиптической кривой. Для проверки~$Q$ может использоваться
алгоритм, определенный в СТБ~34.101.45 (6.2.3).

\begin{note}
В качестве~$Id$ может выступать полное имя, сетевой адрес, уникальный номер,
контрольная характеристика~$Q$.
%
В последнем случае идентификатор может явно не включаться в сертификат, сам
сертификат представлять собой слово~$\langle Q\rangle_{4\ell}$, а его проверка
состоять в сравнении идентификатора стороны протокола с контрольной
характеристикой~$Q$.
\end{note}

В протоколе BMQV передача и проверка сертификата могут выполняться
предварительно, до сеанса протокола, или неявно.
%
Например, сертификат сервера~$B$ может предварительно распространяться как часть
программы, которая реализует протокол со стороны клиента~$A$.
%
Или сертификат может передаваться по каналу, который обеспечивает целостность и
подлинность данных, и тогда проверка этого сертификата выполняется неявно, как
следствие передачи по надежному каналу.

Содержание, формат и способ проверки сертификата в настоящем стандарте не
оговариваются.
%
Тем не менее, при проектировании системы управления сертификатами следует иметь
в виду, что надежность проверки сертификатов определяет надежность
аутентификации посредством протоколов (см.~\ref{COMMON.Strength}).

Типичным является сертификат открытого ключа, определеный в СТБ~34.101.19. В
этом сертификате кроме идентификатора и открытого ключа, определяются параметры
криптографических алгоритмов, срок действия, атрибуты, а также ЭЦП доверенной
стороны под всеми перечисленными данными.
%
Проверка сертификата СТБ~34.101.19 состоит в проверке подписи доверенной
стороны.

\begin{note}
ЭЦП доверенной стороны может сопровождаться 
сертификатом ее открытого ключа, нужного для проверки 
подписи. Новый сертификат подписывается другой
доверенной стороной, подпись которой также может сопровождаться 
сертификатом, и так далее по цепочке, вплоть до достоверно 
полученного самоподписанного сертификата 
[подробнее см. СТБ~34.101.19 (раздел 8)].
%
Сопровождающая ЭЦП доверенной стороны цепочка сертификатов 
может считаться частью~$\Cert(Id,Q)$.
При этом проверка~$\Cert(Id,Q)$ должна вклю\-чать проверку 
сертификатов цепочки.
\end{note}

При формировании~$\Cert(Id,Q)$ может проверяться, что предполагаемый владелец
сертификата знает личный ключ~$d$, которому соответствует~$Q$. Такая проверка
предусмотрена, например, в СТБ~34.101.17.
%
Проверка владения личным ключом неявно проводится в каждом из протоколов BMQV
или BSTS и, вообще говоря, не обязательна при формировании сертификата для этих
протоколов.
%
Если такая проверка все-таки предусмотрена тем или иным регламентом, то она
может быть выполнена с помощью алгоритмов ЭЦП. Для этого владельцу сертификата
должно быть предложено подписать на ключе~$d$ данные сертификата, в том
числе~$Id$ и~$Q$.
%
Корректность ЭЦП означает, что владелец знает личный ключ.

В описанном способе проверки владения личным ключом должны использоваться
алгоритмы ЭЦП, определенные в СТБ~34.101.45. В алгоритмах ЭЦП должны
использоваться те же параметры эллиптической кривой, что и в протоколе, в
котором будет применяться сертификат.

\section{Одноразовые ключи}\label{COMMON.Ephemeral}

Кроме долговременных ключей и паролей стороны используют одноразовые ключи. Во
всех протоколах применяются одноразовый личный ключ~$u\in\{1,2,\ldots,q-1\}$ и
одноразовый открытый ключ~$V\in E_{a,b}^*(\FF_p)$. В протоколе BPACE
дополнительно используется одноразовый секретный ключ~$R\in\{0,1\}^\ell$.

Одноразовые личный и секретный ключи должны вырабатываться без возможности
предсказания и уничтожаться после использования.

Для создания личных и секретных одноразовых ключей может использоваться
физический генератор случайных чисел, удовлетворяющий ТНПА, или алгоритм
генерации псевдослучайных чисел, определенный в СТБ~34.101.47 или в другом ТНПА.
Входные данные алгоритма должны включать секретный ключ, известный только
владельцу генерируемого ключа, и уникальную синхропосылку. Длина ключа алгоритма
генерации должна быть не меньше~$\ell$.

\begin{note*}
Личные ключи~--- числа из множества~$\{1,2,\ldots,q-1\}$~--- 
генерируются, как правило, в два этапа: cначала строятся случайные 
или псевдослучайные двоичные слова, которые затем преобразуются в числа. 
Для генерации личных ключей по такой схеме 
рекомендуется строить слова~$u\in\{0,1\}^{2\ell}$ до тех пор, 
пока не будет выполнено условие~$\bar{u}\in\{1,2,\ldots,q-1\}$,
и объявлять окончательное число~$\bar{u}$ результатом генерации.
В среднем потребуется проверить $2^{2\ell}/(q-1)$ чисел-кандидатов.
\end{note*}

\section{Приветственные сообщения}\label{COMMON.Hello}

Протоколы начинаются с обмена приветственными сообщениями.
Сначала сторона~$A$ отправляет сообщение~$\hello_A$.
%
В этом сообщении~$A$ может указать список протоколов, которые она готова
выполнить, настройки протоколов, другие данные. Настройки могут описывать версию
протокола, уровень стойкости, параметры эллиптической кривой, подсказку по
выбору пароля, отметку времени и др.
%
Сторона~$B$ отвечает сообщением~$\hello_B$.
%
В этом сообщении~$B$ может выбрать устраивающий ее протокол и зафиксировать его
настройки.

Приветственные сообщения участвуют в построении общего ключа и поэтому действия
злоумышленника по изменению приветственных сообщений (например, для изменения
настроек протокола) будут обнаружены.

Формат приветственных сообщений в настоящем cтандарте не регламентируется.
Передача и обработка приветственных сообщений может выполняться предварительно
или неявно.

По умолчанию слова~$\hello_A$ и~$\hello_B$ пустые, если стороны выполняют
заранее оговоренный протокол с фиксированными настройками.

